---
title: "Basic SIR Model"
author: "Claire P. Smith"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../R/hestia_functions.R")
source("../R/simulation.R")

library(rstan)
library(tidyverse)

```

# SIR model

## Simulate some data from a basic SIR model

```{r}

# Simulate data from a basic SIR model for 100 households
# Everyone starts susceptible
# Two observations, first informative about infection (e.g. culture or PCR, 
# second informative about recovery (e.g. IgG))
dat_sim <- sim_sir(eh_prob = 0.01, ih_prob = 0.05, n_hh = 100,
                   hh_size = 1:5, tmax = 100, gamma = 1/5,
                   covs_eh = c(0, 0), covs_ih = c(0, 0),
                   obs_prob = list(c(0.05, 0.95, 0.05),
                                   c(0.01, 0.01, 0.8)),
                   start_prob = c(1, 0, 0),
                   complete_enroll = TRUE)

# Name courcome columns
dat <- dat_sim$obs %>%
  rename(pcr = y1, igg = y2)

```

## Model specification

Define the infection process model, which includes the latent staes and transmission probabilities.

```{r}

# Basic SIR
# For now let's set the value of gamma
inf_process <- make_infection_model(transmit("S", "I"),
                                    transit("I", "R", gamma = NA))

inf_process
get_tranmission_details(inf_process) # for now, to check internal structure

```

Now define the observation process model. In this example we have two observation types, one which is likely to be positive when a person is actively infectious (e.g. PCR test results) and the other which is more likely to be positive when the person is recovered and immune to infection (e.g. IgG antibody).

```{r}
obs_process <- make_observation_model(pcr = c("S" = 0.05, "I" = 0.95, "R" = 0.05),
                                      igg = c("S" = 0.01, "I" = 0.01, "R" = 0.8))

```


Get data into stan format. (This will be put into a function once I make sure it works).

```{r}
## Inputs
# 1. Infection process model
# 2. Observation process model

res_stan <- run_model(inf_model = inf_process, obs_model = obs_process,
                      data = dat, init_probs = c(1-2*1e-10, 1e-10, 1e-10),
                      iter = 1000, cores = 4, save_chains = TRUE,
                      file = "../stan/hmm.stan")


ggplot(res_stan$res, aes(x = param, y = median, ymin = quartile_0.025, ymax = quartile_0.975)) +
  geom_point() +
  geom_errorbar()

```

## SIR model with separate compartments for symptomatic and symptomatic infection

```{r}

# Parallel (no split)
inf_process <- make_infection_model(transmit("S", "Ia", source = "Ia"),
                                    transmit("S", "Is", source = "Is"),
                                    transit("Ia", "R", gamma = NA),
                                    transit("Is", "R", gamma = NA))

# Split, incorrectly specified
# TODO: throw warning
inf_process <- make_infection_model(transmit("S", "Ia", source = c("Ia", "Is")),
                                    transmit("S", "Is", source = c("Ia", "Is")),
                                    transit("Ia", "R", gamma = NA),
                                    transit("Is", "R", gamma = NA))

# Split
inf_process <- make_infection_model(transmit("S", c("Ia", "Is"), source = c("Ia", "Is"), split = c("phi")),
                                    transit("Ia", "R", gamma = NA),
                                    transit("Is", "R", gamma = NA))



```
